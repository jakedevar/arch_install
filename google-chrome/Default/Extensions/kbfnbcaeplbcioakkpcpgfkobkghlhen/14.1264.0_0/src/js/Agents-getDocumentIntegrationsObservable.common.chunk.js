(self.webpackChunk=self.webpackChunk||[]).push([[8616],{9870:(e,t,n)=>{n.d(t,{K:()=>s});class s{constructor(){this._pendingRevision=0,this._finishedRevisions={regular:-1,plagiarism:-1,ai_detector:-1,writing_expert_check:-1,ai_studio:-1,audience_adapt:-1},this._wasChecked={regular:!1,plagiarism:!1,ai_detector:!1,writing_expert_check:!1,ai_studio:!1,audience_adapt:!1},this.reset()}getCheckState(e){return this._pendingRevision>this._finishedRevisions[e]?this._wasChecked[e]?"checking":"full":"idle"}getRevisionCheckState(){return this.getCheckState("regular")}getAsyncChecksState(){return{plagiarism:this.getCheckState("plagiarism"),ai_detector:this.getCheckState("ai_detector"),writing_expert_check:this.getCheckState("writing_expert_check"),ai_studio:this.getCheckState("ai_studio"),audience_adapt:this.getCheckState("audience_adapt")}}stage(e){this._pendingRevision=Math.max(this._pendingRevision,e)}finishRevision(e){this._finishedRevisions.regular=Math.max(this._finishedRevisions.regular,e),this._wasChecked.regular=!0}finishAsyncCheck(e,t){this._finishedRevisions[e]=Math.max(this._finishedRevisions[e],t),this._wasChecked[e]=!0}reset(){this._pendingRevision=0,this._finishedRevisions={regular:-1,plagiarism:-1,ai_detector:-1,writing_expert_check:-1,ai_studio:-1,audience_adapt:-1}}}},27902:(e,t,n)=>{n.d(t,{D8:()=>i.D,Kf:()=>o.K,TJ:()=>i.T,kX:()=>s.k});var s=n(20181),i=n(71365),o=n(9870)},31763:(e,t,n)=>{n.r(t),n.d(t,{getDocumentIntegrationsObservable:()=>P});var s=n(50750),i=n(20161),o=n(84308),r=n(59179),c=n(90572),a=n(10883),u=n(84178),l=n(954),d=n(24666),g=n(8867),h=n(32073),p=n(63532),m=n(84714),S=n(89408),_=(n(24231),n(11970),n(27841),n(66445),n(36802)),f=n(40594),C=n(20680),b=n(79256),I=n(36344),v=n(27902),k=n(13391),w=n(58303),y=n(72847),A=n(67385),D=n(40866),x=n(78767);var R=n(24196),F=n(63753),G=n(90189);class B{static loadContentScriptIntegrationSingleton(e){return null===this._contentScriptInstance&&(this._contentScriptInstance=Promise.all([n.e(308).then(n.bind(n,23541)),this._loadMessageBusClient(e.tabId)]).then((([{AgentsContentScriptIntegration:t},n])=>new t({tabId:e.tabId,messageBusClient:n})))),this._contentScriptInstance}static loadDocumentGroupIntegrationSingleton(e){return null===this._documentGroupInstance&&(this._documentGroupInstance=Promise.all([Promise.all([n.e(5268),n.e(9074),n.e(9153)]).then(n.bind(n,52784)),this._loadMessageBusClient(e.tabId)]).then((([{AgentsDocumentGroupIntegration:t},n])=>new t({...e,messageBusClient:n})))),this._documentGroupInstance}static acquireReferenceFromDocument(e){this._documentReferences.add(e)}static releaseReferenceFromDocument(e){var t;this._documentReferences.delete(e),0===this._documentReferences.size&&(null===(t=this._documentGroupInstance)||void 0===t||t.then((e=>e[Symbol.asyncDispose]())),this._documentGroupInstance=null)}static _loadMessageBusClient(e){return null===this._contentScriptBusClient&&(this._contentScriptBusClient=n.e(4943).then(n.bind(n,53128)).then((({DefaultAgentsMessageBusClient:t})=>new t({messageApi:(0,G.OB)().browserApi.message,script:"cs",tabId:e})))),this._contentScriptBusClient}static dispose(){const e=[];return null!==this._contentScriptInstance&&(e.push(this._contentScriptInstance.then((e=>e[Symbol.dispose]()))),this._contentScriptInstance=null),null!==this._documentGroupInstance&&(e.push(this._documentGroupInstance.then((e=>e[Symbol.asyncDispose]()))),this._documentGroupInstance=null),null!==this._contentScriptBusClient&&(e.push(this._contentScriptBusClient.then((e=>e[Symbol.dispose]()))),this._contentScriptBusClient=null),this._documentReferences.clear(),Promise.all(e).then((()=>{}))}}B._contentScriptBusClient=null,B._contentScriptInstance=null,B._documentGroupInstance=null,B._documentReferences=new Set;var T=n(29416);function P(e){const t=(0,_.Of)(e.documentId),n=e.agentsFeatureFlags.catch((()=>F.W.allDisabled)),G=f.Y.create("Agents.getDocumentIntegrationsObservable"),P=B.loadContentScriptIntegrationSingleton({tabId:e.tabId}),M=(0,s.D)(P).pipe((0,i.w)((e=>e.isActiveTab))),E=(0,s.D)(P).pipe((0,i.w)((e=>e.documentSessionDisposed))),N=(0,o.a)([M,e.isTextFieldFocused]).pipe((0,r.U)((([e,t])=>e&&t))),O=()=>B.loadDocumentGroupIntegrationSingleton({experimentClient:e.experimentClient,user:e.user,tabId:e.tabId,actions:e.actions,telemetry:e.telemetry}),U=E.pipe((0,c.h)((e=>e===t)),(0,a.M)(N),(0,c.h)((([e,t])=>!t)),(0,r.U)((()=>null))).pipe((0,i.w)((()=>N.pipe((0,c.h)(Boolean),(0,u.q)(1),(0,l.O)(!1)))),(0,l.O)(!0),(0,d.x)()),X=new g.y((s=>{const i=new AsyncDisposableStack,r=(0,o.a)([O(),e.textFieldSupportsAgents,n]).subscribe({next:([n,o,r])=>{try{const e=i.use(n.runTextDecorationActivations({documentId:t,textFieldSupportsAgents:o,agentsFeatureFlags:r}));s.next(e.integrations)}catch(t){e.telemetry.error("TextDecorationActivations error",t),G.error("TextDecorationActivations error",t),s.complete()}},error:t=>{e.telemetry.error("getAgentsDocumentGroupIntegration error",t),G.error("getAgentsDocumentGroupIntegration error",t),s.complete()}});return()=>{G.debug(`Disposing text decoration integrations for document ${t}`),r.unsubscribe(),i.disposeAsync()}})),$=new g.y((s=>{const i=new AsyncDisposableStack,r=(0,o.a)([O(),e.textFieldSupportsAgents,n]).subscribe({next:([n,o,r])=>{try{const e=i.use(n.runInlineCardActivations({documentId:t,textFieldSupportsAgents:o,agentsFeatureFlags:r}));s.next(e.integrations)}catch(t){e.telemetry.error("InlineCardActivations error",t),G.error("InlineCardActivations error",t),s.complete()}},error:t=>{e.telemetry.error("getAgentsDocumentGroupIntegration error",t),G.error("getAgentsDocumentGroupIntegration error",t),s.complete()}});return()=>{G.debug(`Disposing inline card integrations for document ${t}`),r.unsubscribe(),i.disposeAsync()}}));return new g.y((s=>{const a=new DisposableStack,u=new h.w0;u.add((()=>a.dispose()));const{capiEvents:l,capiCheckingState:_,capiConnectionStatus:f}=a.use(function(e,t,n){const s=new DisposableStack,o=s.adopt(new h.w0,(e=>e.unsubscribe())),r=(0,C.z)((0,b.P)((()=>{const e=t.get();return e?(0,m.of)({...e,kind:"session_started",allowedFeatures:e.allowedFeatures,isNewSession:void 0===e.reconnectedInfo||void 0!==e.reconnectedInfo.reconnectFailedReason,sessionUuid:e.sessionUuid,domainName:e.domainName,domainCategory:e.domainCategory,defaultDocumentContext:w.YP}):I.E})),e.pipe((0,c.h)(x.C_),(0,i.w)((e=>e.capiEvents)))),a=new v.Kf,u=k.h.create(a.getRevisionCheckState()),l=k.h.create(a.getAsyncChecksState()),d=k.h.create(null),g=k.h.create({}),p=k.h.create({kind:"connecting"});o.add(e.pipe((0,i.w)((e=>e?e.checkingRevisionInfo:I.E))).subscribe((e=>{a.stage(D.Q.getRevisionNumber(e.revision)),u.set(a.getRevisionCheckState()),l.set(a.getAsyncChecksState())})));const S=()=>{const e=p.get();p.set({kind:"disconnected",sessionId:"connecting"===e.kind?null:e.sessionId})};return o.add(r.subscribe((e=>{y.hX.is("session_started")(e)?(p.set({kind:"connected",sessionId:e.sessionUuid,isNewSession:e.isNewSession,allowedFeatures:e.allowedFeatures}),e.isNewSession&&(a.reset(),d.set(null),g.set({})),u.set(a.getRevisionCheckState()),l.set(a.getAsyncChecksState())):y.hX.is("finish")(e)?(a.finishRevision(e.revision),u.set(a.getRevisionCheckState()),d.set({revision:e.revision,outcomeScores:e.outcomeScores,scoreStatus:w.FS(e.scoreStatus)})):y.hX.is("feedback_ack")(e)?d.modify((t=>{var n;return{revision:null!==(n=null==t?void 0:t.revision)&&void 0!==n?n:-1,outcomeScores:e.outcomeScores,scoreStatus:e.scoreStatus}})):y.hX.is("async_check_finished")(e)?(a.finishAsyncCheck(e.check,e.revision),l.set(a.getAsyncChecksState()),g.modify((t=>({...t,[e.check]:{revision:e.revision,outcomeScores:e.outcomeScores}})))):y.hX.is("disconnect")(e)&&S()}))),o.add(e.pipe((0,i.w)((e=>e?e.readyState:I.E))).subscribe((e=>{e===A.kQ.disconnected&&S()}))),{capiConnectionStatus:p,capiCheckingState:{checkingState:u,asyncCheckingState:l,scores:d,asyncScores:g,textInfo:n},capiEvents:r,[Symbol.dispose]:()=>s.dispose()}}(e.checkingService,e.capiStartAckMessage,e.textInfo)),F=U.pipe((0,d.x)(),(0,p.b)((e=>G.debug(`Should integrate in document ${t}: ${e}`))),(0,i.w)((s=>{return s?(0,o.a)([(i={capiConnectionStatus:f,capiCheckingState:_,capiEvents:l},new g.y((s=>{const r=new AsyncDisposableStack;B.acquireReferenceFromDocument(t);const c=(0,o.a)([O(),e.textFieldSupportsAgents,n]).subscribe({next:([n,o,c])=>{try{const a=r.use(n.runDocumentActivations({documentId:t,getPlainText:e.getPlainText,textChanges:e.textChanges,isTextFieldFocused:e.isTextFieldFocused,textFieldSupportsAgents:o,agentsFeatureFlags:c,checkingService:e.checkingService,pushedContentService:e.pushedContentService,...i}));s.next(a.integrations)}catch(t){e.telemetry.error("DocumentActivations error",t),G.error("DocumentActivations error",t),s.complete()}},error:t=>{e.telemetry.error("getAgentsDocumentGroupIntegration error",t),G.error("getAgentsDocumentGroupIntegration error",t),s.complete()}});return()=>{G.debug(`Disposing document integrations for document ${t}`),c.unsubscribe(),r.disposeAsync(),B.releaseReferenceFromDocument(t)}}))),X,$]).pipe((0,r.U)((([e,t,n])=>({documentIntegrations:e,textDecorationIntegrations:t,inlineCardIntegrations:n})))):(0,m.of)(null);var i})),(0,S.d)({bufferSize:1,refCount:!0}));return u.add(F.subscribe(s)),e.experimentClient.isGateEnabled(R.Nl.AgentsInfoTelemetry)&&u.add(function(e,t,n,s=1e3){return e.pipe((0,i.w)((e=>e?(0,o.a)([Promise.allSettled(e.documentIntegrations),Promise.allSettled(e.textDecorationIntegrations),Promise.allSettled(e.inlineCardIntegrations)]):(0,m.of)(null))),(0,c.h)(x.C_),(0,T.b)(s)).subscribe((e=>{const[s,i,o]=e,r=s.filter((e=>"fulfilled"===e.status)),c=s.filter((e=>"rejected"===e.status)),a=i.filter((e=>"fulfilled"===e.status)),u=i.filter((e=>"rejected"===e.status)),l=o.filter((e=>"fulfilled"===e.status)),d=o.filter((e=>"rejected"===e.status));n.info("Agents integrations",{documentId:t,documentIntegrations:{total:s.length,successful:r.length,failed:c.length},textDecorationIntegrations:{total:i.length,successful:a.length,failed:u.length},inlineCardIntegrations:{total:o.length,successful:l.length,failed:d.length}})}))}(F,t,e.telemetry,e.integrationsTelemetryInfoDebounceTimeMs)),u})).pipe((0,S.d)({bufferSize:1,refCount:!0}))}}}]);