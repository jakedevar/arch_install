(self.webpackChunk=self.webpackChunk||[]).push([[5320],{7616:(e,t,s)=>{s.d(t,{N:()=>n});var i=s(8867);function n(e){return new i.y((t=>{const s=new DisposableStack,i=s.use(e());return s.adopt(i.subscribe((e=>t.next(e))),(e=>e.unsubscribe())),()=>s.dispose()}))}},27902:(e,t,s)=>{s.d(t,{D8:()=>n.D,N4:()=>r.N,TJ:()=>n.T,kX:()=>i.k});var i=s(20181),n=s(71365),r=s(7616)},18585:(e,t,s)=>{s.r(t),s.d(t,{AgentsSidePanelIntegration:()=>bt});var i=s(92379),n=s(54784),r=s(69088);var o=s(90572),a=s(24666),l=s(20161),c=s(84714),u=(s(24231),s(11970),s(27841),s(66445),s(27902)),d=s(13391),h=s(57747),p=s(39963),m=s(78767),g=s(40594),b=s(81762),v=s(99161),f=s(89662),k=s(70512);const w={events:{documentSessionDisposed:(0,f.d)()},state:{activeTabId:(0,k.x)(),"activeDocument/:tabId":(0,k.x)(),"agentsFeatureFlags/:tabId":(0,k.x)(),lastActivePanelAgentId:(0,k.x)(),activePanelAgentId:(0,k.x)()}};var I,y,_,S=s(74822),P=s(21070),C=s(79256),A=s(18519),M=s(71051),x=s(63532),B=s(66878),D=s(36344),W=e=>{throw TypeError(e)},T=(e,t,s)=>t.has(e)||W("Cannot "+s),O=(e,t,s)=>(T(e,t,"read from private field"),s?s.call(e):t.get(e)),$=(e,t,s)=>t.has(e)?W("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s),N=(e,t,s,i)=>(T(e,t,"write to private field"),t.set(e,s),s);class E{constructor(e){$(this,I,new DisposableStack),$(this,y,new Map),$(this,_),N(this,_,e)}send(e){O(this,_).send(e)}subscribe(e){const t=new DisposableStack;t.defer((()=>{const t=O(this,y).get(e);null==t||t[Symbol.dispose](),O(this,y).delete(e)}));const s=new DisposableStack;return O(this,y).set(e,s),null!==O(this,_)&&s.use(O(this,_).subscribe(e)),t}connectToServerPort(e){N(this,_,e);for(const[e,t]of O(this,y)){t[Symbol.dispose]();const s=O(this,_).subscribe(e);O(this,y).set(e,s)}}[Symbol.dispose](){O(this,I).dispose()}}I=new WeakMap,y=new WeakMap,_=new WeakMap;var R=s(23537),j=s(57206),F=s(1933);function G(e,t){if(e===t)return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every(((e,s)=>G(e,t[s])));if(Array.isArray(e)!==Array.isArray(t))return!1;const s=Object.keys(e),i=new Set(Object.keys(t));if(s.length!==i.size)return!1;for(const n of s)if(!i.has(n)||!G(e[n],t[n]))return!1;return!0}var V,Y,q,z,K,X,L,H,J,Q,U,Z,ee,te,se,ie,ne,re,oe,ae,le,ce,ue,de,he,pe,me,ge,be,ve,fe,ke,we,Ie,ye,_e,Se=s(83535),Pe=Object.defineProperty,Ce=Object.defineProperties,Ae=Object.getOwnPropertyDescriptors,Me=Object.getOwnPropertySymbols,xe=Object.prototype.hasOwnProperty,Be=Object.prototype.propertyIsEnumerable,De=e=>{throw TypeError(e)},We=(e,t,s)=>t in e?Pe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,Te=(e,t)=>{for(var s in t||(t={}))xe.call(t,s)&&We(e,s,t[s]);if(Me)for(var s of Me(t))Be.call(t,s)&&We(e,s,t[s]);return e},Oe=(e,t,s)=>t.has(e)||De("Cannot "+s),$e=(e,t,s)=>(Oe(e,t,"read from private field"),s?s.call(e):t.get(e)),Ne=(e,t,s)=>t.has(e)?De("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s),Ee=(e,t,s,i)=>(Oe(e,t,"write to private field"),t.set(e,s),s),Re=(e,t,s)=>(Oe(e,t,"access private method"),s);class je{constructor(e){var t,s;Ne(this,Z),Ne(this,V,new DisposableStack),Ne(this,Y),Ne(this,q),Ne(this,z),Ne(this,K),Ne(this,X,!1),Ne(this,L,null),Ne(this,H,$e(this,V).adopt(new Map,(e=>e.clear()))),Ne(this,J,$e(this,V).adopt(new Map,(e=>e.clear()))),Ne(this,Q,$e(this,V).adopt(new Map,(e=>e.clear()))),Ne(this,U,$e(this,V).adopt(new Map,(e=>e.clear()))),Ee(this,Y,e.serverPort),Ee(this,q,null!=(t=e.tracingOptions)?t:{enabled:!1}),Ee(this,z,e.retainedValueStorage),Ee(this,K,`${(0,Se.v)()}${void 0!==e.name?`(${e.name})`:""}`),$e(this,V).use(null==(s=$e(this,Y))?void 0:s.subscribe((e=>Re(this,Z,te).call(this,e)))),$e(this,V).defer((()=>{var t;return null==(t=e.retainedValueStorage)?void 0:t.clear()})),void 0!==$e(this,Y)&&this.connect()}isConnected(){return!$e(this,X)}waitConnected(){var e,t;return null!=(t=null==(e=$e(this,L))?void 0:e.promise)?t:Promise.resolve()}connect(){var e;if(!$e(this,Y))return Promise.resolve();null==(e=$e(this,L))||e.reject(new Error("Connection attempt superseded by a newer one")),Ee(this,X,!0),$e(this,U).forEach((e=>e.setBufferingEnabled(!0)));const t=`${$e(this,K)}|${(0,Se.v)()}`,s=(0,F.B)();return Ee(this,L,{attempId:t,resolve:()=>{var e;(null==(e=$e(this,L))?void 0:e.attempId)===t&&(Ee(this,X,!1),Ee(this,L,null),$e(this,U).forEach((e=>e.setBufferingEnabled(!1))),s.resolve())},reject:e=>{var i;(null==(i=$e(this,L))?void 0:i.attempId)===t&&(Ee(this,X,!1),Ee(this,L,null),s.reject(e))},promise:s.promise}),$e(this,Y).send({kind:"handshake",id:t,subscriptions:[...$e(this,H).values()].map((e=>({key:e.key,clientId:e.clientId,subscriptionId:e.portId,timestamp:e.timestamp}))),retainedValues:[...$e(this,Q).entries()].map((([e,t])=>({key:e,value:t.value,clientId:t.lastWriterClientId,timestamp:t.modifiedTimestamp})))}),s.promise}createPort(e){const t=null==e?void 0:e.name,s=`${$e(this,K)}|${(0,Se.v)()}${void 0!==t?`(${t})`:""}`,i=$e(this,V).use(new Fe({send:e=>Re(this,Z,ne).call(this,s,e),notifyDispose:()=>Re(this,Z,ee).call(this,s),shouldBufferMessages:$e(this,X),tracingOptions:void 0!==(null==e?void 0:e.tracingOptions)?e.tracingOptions:$e(this,q),portId:s}));return $e(this,U).set(s,i),i}[Symbol.dispose](){$e(this,V).dispose()}}V=new WeakMap,Y=new WeakMap,q=new WeakMap,z=new WeakMap,K=new WeakMap,X=new WeakMap,L=new WeakMap,H=new WeakMap,J=new WeakMap,Q=new WeakMap,U=new WeakMap,Z=new WeakSet,ee=function(e){const t=$e(this,U).get(e);if(void 0!==t){for(const[t,s]of $e(this,H).entries())s.portId===e&&Re(this,Z,ue).call(this,e,{kind:"unsubscribe",subscriptionId:t});t[Symbol.dispose](),$e(this,U).delete(e)}},te=function(e){switch(e.kind){case"publish":Re(this,Z,ie).call(this,e);break;case"handshake-ack":Re(this,Z,se).call(this,e)}},se=function(e){var t,s;if((null==(t=$e(this,L))?void 0:t.attempId)===e.id){$e(this,L).resolve();for(const t of e.newerRetainedValues)$e(this,Q).set(t.key,{value:t.value,lastWriterClientId:t.clientId,modifiedTimestamp:t.timestamp}),null==(s=$e(this,z))||s.set(t.key,t.value),Re(this,Z,pe).call(this,{kind:"publish",key:t.key,value:t.value,timestamp:t.timestamp,clientId:t.clientId})}},ie=function(e){var t,s;const i=$e(this,Q).get(e.key);if(void 0!==i){if(e.timestamp<=i.modifiedTimestamp)return;$e(this,Q).set(e.key,{value:e.value,lastWriterClientId:e.clientId,modifiedTimestamp:e.timestamp}),null==(t=$e(this,z))||t.set(e.key,e.value)}if(null==(s=e.route)||!s.includes($e(this,K)))return void 0!==e.toSubscriptionId?Re(this,Z,de).call(this,e):void 0!==e.toClientId?Re(this,Z,he).call(this,e):Re(this,Z,pe).call(this,e)},ne=function(e,t){switch(t.kind){case"publish":Re(this,Z,re).call(this,t);break;case"subscribe":Re(this,Z,ae).call(this,e,t);break;case"unsubscribe":Re(this,Z,ue).call(this,e,t);break;case"handshake":Re(this,Z,oe).call(this,e,t)}},re=function(e){var t,s,i;const n=$e(this,Q).get(e.key);void 0!==n&&e.timestamp>n.modifiedTimestamp?($e(this,Q).set(e.key,{value:e.value,lastWriterClientId:e.clientId,modifiedTimestamp:e.timestamp}),null==(t=$e(this,z))||t.set(e.key,e.value)):void 0!==n&&Re(this,Z,he).call(this,{kind:"publish",key:e.key,value:n.value,timestamp:n.modifiedTimestamp,clientId:n.lastWriterClientId,route:[$e(this,K)],toClientId:e.clientId});const r=((e,t)=>Ce(e,Ae(t)))(Te({},e),{route:[...null!=(s=e.route)?s:[],$e(this,K)]});void 0!==e.toClientId?Re(this,Z,he).call(this,r):Re(this,Z,pe).call(this,r),null==(i=$e(this,Y))||i.send(r)},oe=function(e,t){var s,i;const n=$e(this,U).get(e);if(void 0===n)return void(0,R.P)("No port for handshake message",e);for(const s of t.subscriptions)Re(this,Z,le).call(this,{key:s.key,portId:e,timestamp:s.timestamp,clientId:s.clientId,subscriptionId:s.subscriptionId});const r=[],o=[];for(const e of t.retainedValues){const t=$e(this,Q).get(e.key);void 0!==t&&t.modifiedTimestamp>=e.timestamp?r.push({key:e.key,value:t.value,timestamp:t.modifiedTimestamp,clientId:t.lastWriterClientId}):($e(this,Q).set(e.key,{value:e.value,lastWriterClientId:e.clientId,modifiedTimestamp:e.timestamp}),null==(s=$e(this,z))||s.set(e.key,e.value),o.push({key:e.key,value:e.value,timestamp:e.timestamp,clientId:e.clientId}))}n.outbound({kind:"handshake-ack",id:t.id,newerRetainedValues:r}),null==(i=$e(this,Y))||i.send(t);for(const e of o)Re(this,Z,pe).call(this,{kind:"publish",key:e.key,value:e.value,timestamp:e.timestamp,clientId:e.clientId,route:[$e(this,K)],excludeSubscriptionIds:t.subscriptions.map((e=>e.subscriptionId))})},ae=function(e,t){var s;$e(this,H).has(t.subscriptionId)?(0,R.P)("Subscription with this id already exists",t.subscriptionId):(Re(this,Z,le).call(this,Te({portId:e},t)),void 0!==t.retain&&Re(this,Z,ce).call(this,t,t.retain.value,e),null==(s=$e(this,Y))||s.send(t))},le=function(e){const t={key:e.key,portId:e.portId,timestamp:e.timestamp,clientId:e.clientId};$e(this,H).set(e.subscriptionId,t);let s=$e(this,J).get(e.key);void 0===s&&(s=new Set,$e(this,J).set(e.key,s)),s.add(e.subscriptionId)},ce=function(e,t,s){var i,n,r,o,a;if("write"===(null==(i=e.retain)?void 0:i.kind)&&e.timestamp>(null!=(r=null==(n=$e(this,Q).get(e.key))?void 0:n.modifiedTimestamp)?r:Number.MIN_SAFE_INTEGER)&&!G(t,null==(o=$e(this,Q).get(e.key))?void 0:o.value))$e(this,Q).set(e.key,{value:t,lastWriterClientId:e.clientId,modifiedTimestamp:e.timestamp}),null==(a=$e(this,z))||a.set(e.key,t),void 0!==$e(this,U).get(s)&&Re(this,Z,pe).call(this,{kind:"publish",key:e.key,value:t,timestamp:e.timestamp,clientId:e.clientId,route:[$e(this,K)],excludeSubscriptionIds:[e.subscriptionId]});else{const i=$e(this,Q).get(e.key);if(void 0===i)return;void 0!==$e(this,U).get(s)&&!G(t,i.value)&&Re(this,Z,de).call(this,{kind:"publish",key:e.key,value:i.value,timestamp:i.modifiedTimestamp,clientId:i.lastWriterClientId,route:[$e(this,K)],toSubscriptionId:e.subscriptionId})}},ue=function(e,t){var s,i;const n=$e(this,H).get(t.subscriptionId);if(void 0===n)return void(0,R.P)("No subscription with this id",t.subscriptionId);if(n.portId!==e)return void(0,R.P)("Subscription does not belong to this port",t.subscriptionId,e);$e(this,H).delete(t.subscriptionId);const r=$e(this,J).get(n.key);void 0!==r&&(r.delete(t.subscriptionId),0===r.size&&($e(this,J).delete(n.key),$e(this,Q).delete(n.key),null==(s=$e(this,z))||s.delete(n.key))),null==(i=$e(this,Y))||i.send(t)},de=function(e){const t=$e(this,H).get(e.toSubscriptionId);if(void 0===t)return void(0,R.P)("No subscription with this id",e.toSubscriptionId);const s=$e(this,U).get(t.portId);void 0!==s?s.outbound(e):(0,R.P)("No port for subscription with this id",e.toSubscriptionId)},he=function(e){const t=Re(this,Z,me).call(this,e.key,e.toClientId,void 0);for(const s of t)s.outbound(e)},pe=function(e){const t=Re(this,Z,me).call(this,e.key,void 0,e.excludeSubscriptionIds);for(const s of t)s.outbound(e)},me=function(e,t,s){const i=new Set,n=$e(this,J).get(e);for(const e of null!=n?n:[]){if(s&&s.includes(e))continue;const n=$e(this,H).get(e);if(void 0===n||void 0!==t&&t!==n.clientId)continue;const r=$e(this,U).get(n.portId);void 0!==r&&i.add(r)}return i};class Fe{constructor(e){var t;Ne(this,Ie),Ne(this,ge,new DisposableStack),Ne(this,be),Ne(this,ve),Ne(this,fe,$e(this,ge).use(new j.x)),Ne(this,ke,[]),Ne(this,we),Ee(this,ve,e.send),Ee(this,we,e.shouldBufferMessages),$e(this,ge).defer((()=>e.notifyDispose())),Ee(this,be,null!=(t=e.tracingOptions)?t:{enabled:!1}),this.portId=e.portId}send(e){Re(this,Ie,_e).call(this,"inbound",e),$e(this,we)&&"handshake"!==e.kind?$e(this,ke).push(e):(Re(this,Ie,ye).call(this),$e(this,ve).call(this,e))}subscribe(e){const t=new DisposableStack;return $e(this,ge).defer((()=>t.dispose())),t.use($e(this,fe).subscribe({next:e,complete:()=>t.dispose()})),t}[Symbol.dispose](){$e(this,ge).dispose()}outbound(e){Re(this,Ie,_e).call(this,"outbound",e),$e(this,fe).next(e)}setBufferingEnabled(e){Ee(this,we,e),e||Re(this,Ie,ye).call(this)}}ge=new WeakMap,be=new WeakMap,ve=new WeakMap,fe=new WeakMap,ke=new WeakMap,we=new WeakMap,Ie=new WeakSet,ye=function(){if($e(this,ke).length>0){for(const e of $e(this,ke))$e(this,ve).call(this,e);$e(this,ke).length=0}},_e=function(e,t){};class Ge extends je{constructor(e){super(e)}}class Ve{constructor(e){this._init=e,this._disposables=new DisposableStack,this._logger=g.Y.create("AgentsReconnectingMessageBusRouterClient"),this._telemetry="cs"===this._init.script?(0,p.Tb)().agents.cs():(0,p.Tb)().agents.sidePanel,this._reconnectSubject=new S.x,this._volatileMessageBusServerPort=this._getNewPort(),this._messageBusServerPort=this._disposables.use(new E(this._volatileMessageBusServerPort)),this._messageBusContentScriptRouter=this._disposables.use(new Ge({tracingOptions:{enabled:!1,color:"green"},serverPort:this._messageBusServerPort,name:this._init.routerName})),this._disposables.defer((()=>this._volatileMessageBusServerPort[Symbol.dispose]()));let t=0;this._disposables.adopt(this._reconnectSubject.pipe((0,P.z)((()=>{var e,s;return(0,C.P)((()=>{this._logger.info("Reconnecting to message bus server... Attempt #"+ ++t);const e=this._volatileMessageBusServerPort;return this._volatileMessageBusServerPort=this._getNewPort(),this._messageBusServerPort.connectToServerPort(this._volatileMessageBusServerPort),e[Symbol.dispose](),this._messageBusContentScriptRouter.connect()})).pipe((0,A.V)(null!==(e=this._init.reconnectTimeoutMs)&&void 0!==e?e:1e3),(0,M.X)({count:null!==(s=this._init.reconnectMaxAttempts)&&void 0!==s?s:5}),(0,x.b)((()=>{this._logger.info("Reconnected to message bus server"),t=0})),(0,B.K)((e=>(this._telemetry.error("Failed to reconnect to message bus server",e),this._logger.error("Failed to reconnect to message bus server",e),D.E))))}))).subscribe(),(e=>e.unsubscribe()))}createPort(...e){return this._messageBusContentScriptRouter.createPort(...e)}[Symbol.dispose](){this._disposables.dispose()}_getNewPort(){return function(e,t,s){const i=new DisposableStack,n=e();i.defer((()=>{var e;return null===(e=n.removeMessageListeners)||void 0===e?void 0:e.call(n)}));const r=new S.x;return n.onDisconnect((()=>{var e;i.disposed||(null===(e=n.removeMessageListeners)||void 0===e||e.call(n),t())})),n.onMessage((e=>{i.disposed||r.next(e)})),{send:e=>{if(i.disposed)return s.warn("Cannot send message to a disposed BG port"),void g.Y.create("createClientPort").warn("Cannot send message to a disposed BG port");try{n.postMessage(e)}catch(e){s.error("Error sending message to BG port",e),g.Y.create("createClientPort").error("Error sending message to BG port",e)}},subscribe:e=>{if(i.disposed)return s.warn("Cannot subscribe to a disposed BG port"),g.Y.create("createClientPort").warn("Cannot subscribe to a disposed BG port"),new DisposableStack;const t=i.use(new DisposableStack);return t.adopt(r.subscribe(e),(e=>e.unsubscribe())),t},[Symbol.dispose]:()=>i.dispose()}}(this._init.createContentScriptPort,(()=>this._reconnectSubject.next()),this._telemetry)}}function Ye(e){return`agents/${e}`}function qe(e,...t){return ze(e,...t)}function ze(e,...t){return`agents/@impl/${e}${He(t)}`}function Ke(e,t,...s){return Xe(e,t,...s)}function Xe(e,t,...s){return`${Ye(e)}/${t}${He(s)}`}function Le(e,...t){return`agents/${e}${He(t)}`}function He(e){const t=e.filter(Boolean).join("/");return t?`/${t}`:""}class Je{constructor(e){this._disposables=new DisposableStack,this._messageBusRouter=this._disposables.use(new Ve({script:e.script,createContentScriptPort:()=>e.messageApi.createPortConnection(v.Tt.messageBusPort),routerName:Le(e.script,e.tabId)})),this.platformBus=this._disposables.use((0,u.kX)({port:this._messageBusRouter.createPort({name:qe(e.script,e.tabId)}),clientId:ze(e.script,e.tabId),keyPrefix:"agents/@impl",protocol:w}))}createPort(...e){return this._messageBusRouter.createPort(...e)}[Symbol.dispose](){this._disposables.dispose()}}var Qe=s(15805),Ue=s(42332),Ze=s(34903),et=s(74441),tt=s(60159);const st={[s(79650).f.id]:"ReaderReactions",[Ze.f.id]:"Humanizer",[et.f.id]:"Paraphraser",[Ue.f.id]:"ExpertReview",[Qe.f.id]:"AIDetector",[tt.f.id]:"Plagiarism"};var it=s(80891);class nt{constructor(e){this._experimentClient=e}isAssigned(e,...t){if(e instanceof it.Cc)return this._experimentClient.isGateEnabled(e);const s=this._experimentClient.getTreatment(e);return null!==s&&s!==it.q4&&t.includes(s)}getTreatment(e){const t=this._experimentClient.getTreatment(e);return t===it.q4?null:t}peekExperiment(e,...t){const s=this._experimentClient.peekTreatment(e);return null!==s&&s!==it.q4&&t.includes(s)}}var rt=s(12518),ot=s(16876),at=s(37997);const lt=e=>{const t=new Set;return"edge"!==e.browser&&"msie"!==e.browser&&t.add(at.L.Flag.supportsSVGDominantBaseline),{has:e=>t.has(e)}};class ct{constructor(){this.openUrl=e=>(0,rt.Y3)((()=>{document.location.href=e.toString()}),rt.KC),this.openPopup=e=>(0,rt.Y3)((()=>{const t=self.open(e.toString(),"_blank","noopener,noreferrer");t&&(t.opener=null)}),rt.KC)}}var ut=s(24196);var dt=s(40795);function ht(e){return{[Symbol.asyncDispose]:async()=>{if(!e)return;const t=await e;t&&(!function(e){return Symbol.dispose in e}(t)?function(e){return Symbol.asyncDispose in e}(t)&&await t[Symbol.asyncDispose]():t[Symbol.dispose]())}}}var pt=s(92120),mt=s(42082);function gt(){const e=g.Y.create("useOpenChatWithMessage"),{commandExecutor:t}=(0,pt.ar)();return s=>{t?(e.debug("Opening chat agent with message:",s),t.execute({kind:pt.FP.MessageAgent,agentId:mt._N,message:{kind:pt.IQ.Command,command:{kind:pt.pd.CreateChat,message:{content:s}}}}),t.execute({kind:pt.FP.OpenAgent,agentId:mt._N})):e.error("Command executor or send message not available")}}class bt{constructor(e){this._initOptions=e,this._disposables=new AsyncDisposableStack,this._logger=g.Y.create("Agents.SidePanelIntegration"),this._experimentationService=new nt(this._initOptions.experimentClient),this._agentDefinitions=(0,dt.c)(this._initOptions.experimentClient),this._messageBusClient=this._disposables.use(new Je({messageApi:(0,b.O)().browserApi.message,script:"side-panel"})),this._agentPlatformBus=this._messageBusClient.platformBus,this._activePanelAgentId=this._disposables.use(this._agentPlatformBus.state.lastActivePanelAgentId.create(null))}setActiveAgentId(e){this._activePanelAgentId.set(e)}loadAssistantAgents(){if(!(0,ut.w4)(this._initOptions.experimentClient))return d.h.create([]);const e=this._runAssistantActivations(),t=d.h.create(new Map(e.map((e=>[e.agentId,null]))));for(const s of e){const{agentId:e,integrationResult:n}=s;n.then((s=>{s?t.modify((t=>{const n=i.memo((e=>s.renderIcon(e)));n.displayName=`Icon-${e}`;const r=i.memo((()=>{const e=gt();return s.renderPanel({onClosePanel:void 0,onChatAIMessage:e})}));return r.displayName=`Panel-${e}`,new Map(t).set(e,{id:e,title:s.title,renderPanel:()=>i.createElement(r),renderIcon:e=>i.createElement(n,e)})})):this._logger.debug(`Agent ${e} was not activated due to allowed features check`)})).catch((t=>{this._logger.error(`Failed to get assistant integration result for agent ${e}`,t),(0,p.Tb)().agents.sidePanel.error("Failed to get assistant integration result for agent",t,{agentId:e})}))}return t.view((e=>[...e.values()].filter(m.C_)))}async _getAllowedFeatures(){if(!this._initOptions.experimentClient.isGateEnabled(ut.Nl.AgentsCAPIFiltering))return this._logger.debug("CAPI filtering gate is disabled, using all agents"),null;const e=this._initOptions.checkingServiceProvider.getCheckingService();if(!e)return this._logger.debug("No checking service available, skipping all agents"),[];try{const a=e=>"start"===e.action,l=(await(t=e.capiMessages.pipe((0,o.h)(a)),i="object"==typeof s,new Promise((function(e,o){var a=new r.Hp({next:function(t){e(t),a.unsubscribe()},error:o,complete:function(){i?e(s.defaultValue):o(new n.K)}});t.subscribe(a)})))).allowedFeatures||[];return this._logger.debug("Received allowed features from CAPI:",l),l}catch(e){return this._logger.error("Failed to get allowed features from CAPI:",e),[]}var t,s,i}_runAssistantActivations(){const e=h.W.detect(),t=function(e){return new ot.f(lt(e),new ct)}(e),s=this._disposables.use(function(e){const t=new DisposableStack,s=t.use(e.state.activeTabId.view(null)),i=d.h.create(null);return t.adopt(s.pipe((0,a.x)(),(0,l.w)((t=>null===t?(0,c.of)(null):(0,u.N4)((()=>e.state.activeDocument.view(t,null)))))).subscribe((e=>i.set(e))),(e=>e.unsubscribe())),{activeDocument:i,[Symbol.dispose]:()=>t.dispose()}}(this._agentPlatformBus)).activeDocument,i=this._disposables.use(this._agentPlatformBus.state.activeTabId.view(null)),n=d.h.create(null);this._disposables.adopt(i.pipe((0,a.x)(),(0,l.w)((e=>null===e?(0,c.of)(null):(0,u.N4)((()=>this._agentPlatformBus.state.agentsFeatureFlags.view(e,null)))))).subscribe((e=>n.set(e))),(e=>e.unsubscribe()));const r={user:this._initOptions.user.view((e=>({id:e.id,firstName:e.firstName,email:e.email,free:!e.premium,anonymous:e.anonymous})))},o=this._getAllowedFeatures();return this._agentDefinitions.map((i=>{const a=o.then((async o=>{var a,l;if(null!==o){const e=dt.v[i.id];if(e&&!o.includes(e))return this._logger.debug(`Agent ${i.id} requires feature ${e} which is not in allowed features, skipping activation`),null}this._logger.debug(`Running assistant activation for ${i.id}`);const c=new AsyncDisposableStack;this._disposables.defer((()=>c.disposeAsync()));const h=c.use(this._messageBusClient.createPort({name:Ke(i.id,"assistant")})),m=d.h.combine(s,n,((e,t)=>{var s;if(!e)return null;const n=st[i.id],r=!!t&&(null!==(s=t[n])&&void 0!==s&&s);return{...e,supportsAgents:e.supportsAgents&&r}})),g={activeDocument:m,documentSessionDisposed:this._agentPlatformBus.events.documentSessionDisposed.view()};try{const s=null===(l=(a=i.integrations).assistantActivate)||void 0===l?void 0:l.call(a,{bus:c.use((0,u.kX)({port:h,clientId:Xe(i.id,"assistant"),keyPrefix:Ye(i.id),protocol:i.protocol})),documents:g,navigation:{isPanelOpen:this._activePanelAgentId.view((e=>e===i.id))},experimentation:this._experimentationService,platformInfo:e,environment:t,userService:r});return s?(c.use(ht(s.catch((()=>null)))),s):(c.disposeAsync(),null)}catch(e){return c.disposeAsync(),this._logger.error(`Assistant activation error for agent ${i.id}`,e),(0,p.Tb)().agents.sidePanel.error("Assistant activation failed for agent",e,{agentId:i.id}),null}}));return{agentId:i.id,integrationResult:a}}))}dispose(){this._disposables.disposeAsync()}}}}]);